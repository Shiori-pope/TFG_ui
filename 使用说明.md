# 数字人说话视频生成系统 - 使用说明

## 项目概述

基于 Flask 的 Web 应用系统，集成了多个说话人脸生成模型和 GPT-SoVITS 语音合成功能。

## 核心功能

### 1. 模型训练
- 支持 JoyGen 模型训练
- 支持视频文件上传
- 可自定义训练参数

### 2. 视频生成
- 使用训练好的模型生成说话视频
- 支持音频文件上传
- 支持 JoyGen 模型

### 3. 实时对话系统
- 语音识别（Google Speech Recognition）
- AI 对话（智谱 AI GLM-4-Plus）
- 语音合成（GPT-SoVITS）
- 视频生成（待完善）

## 环境要求

### Python 依赖
```bash
pip install flask
pip install SpeechRecognition
pip install zhipuai
pip install requests
```

### 外部服务

#### GPT-SoVITS 语音合成服务
```bash
cd GPT-SoVITS-v2pro
python api_v2.py -a 127.0.0.1 -p 9880 -c GPT_SoVITS/configs/tts_infer.yaml
```

**注意**: 语音合成功能需要 GPT-SoVITS 服务运行在 `http://127.0.0.1:9880`

## 启动步骤

### 1. 启动 GPT-SoVITS 服务（可选，用于语音合成）

```bash
# 进入 GPT-SoVITS 目录
cd GPT-SoVITS-v2pro

# 启动 TTS API 服务
python api_v2.py -a 127.0.0.1 -p 9880
```

### 2. 启动 Flask 应用

```bash
# 在项目根目录
python app.py
```

### 3. 访问 Web 界面

打开浏览器访问: `http://127.0.0.1:5001`

## 功能使用

### 模型训练

1. 访问 `http://127.0.0.1:5001/model_training`
2. 选择模型（JoyGen）
3. 方式一：直接输入视频路径
   - 例如：`./uploads/my_video.mp4`
4. 方式二：使用文件上传
   - 点击"选择文件"上传视频
   - 点击"上传视频"按钮
   - 自动填入文件路径
5. 设置训练步数（默认 5000，推荐 3000-10000）
6. 选择 GPU
7. 点击"Training!"开始训练

**训练完成后**：
- 模型保存在 `./JoyGen/checkpoints/{视频名称}_steps{训练步数}`
- 例如：`./JoyGen/checkpoints/my_video_steps5000`
- 将此路径用于视频生成

**提示**: 
- 模型训练是**可选的**，用于针对特定人物进行微调
- 如果不训练，可以直接使用 `./JoyGen/pretrained_models/joygen` 预训练模型
- 训练时间取决于 GPU 性能和训练步数

### 视频生成

1. 访问 `http://127.0.0.1:5001/video_generation`
2. 选择模型（JoyGen）
3. 输入模型目录路径
   - **使用预训练默认模型**: `./JoyGen/pretrained_models/joygen`（已自动填入）
   - **使用自己训练的模型**: `./JoyGen/checkpoints/{video_name}_steps{steps}`
   - 例如: `./JoyGen/checkpoints/my_video_steps5000`
4. 输入参考视频路径
   - 预训练模型默认：`./JoyGen/test_data/example_5s.mp4`
   - 训练后模型：使用训练时的视频路径
5. 方式一：直接输入音频路径
6. 方式二：使用文件上传
   - 点击"选择文件"上传音频
   - 点击"上传音频"按钮
7. 选择 GPU
8. 点击"生成视频"

**生成结果**：
- 视频保存在 `./static/videos/` 目录
- 同时保存在 `./JoyGen/results/{视频名}_{音频名}/talk/` 目录

**提示**: 
- 如果没有训练自己的模型，可以直接使用预训练模型 `./JoyGen/pretrained_models/joygen`
- 预训练模型适用于大多数通用场景，无需训练即可使用
- 参考视频决定了生成视频的人物形象

### 实时对话

1. 访问 `http://127.0.0.1:5001/chat_system`
2. 选择视频素材
   - 15秒示例视频（默认推荐）
   - 5秒示例视频
3. 点击"开始录音"录制语音，或上传音频文件
4. 点击"🎤 开始对话"
5. 系统自动完成 4 步流程：
   - **步骤1**: 语音识别 → 文字（Google Speech Recognition）
   - **步骤2**: AI 生成回答（智谱 GLM-4-Plus）
   - **步骤3**: 文字 → 语音（GPT-SoVITS，自动启动）
   - **步骤4**: 生成数字人视频（JoyGen）
6. 等待处理完成，视频显示在右侧

**功能说明**：
- ✅ 完全自动化：一键完成从语音输入到视频输出
- ✅ 智能对话：使用智谱 AI 生成自然语言回答
- ✅ 语音合成：GPT-SoVITS 高质量语音合成
- ✅ 数字人视频：JoyGen 生成说话视频

## 文件结构

```
csv_front/
├── app.py                          # Flask 主程序
├── backend/
│   ├── chat_engine.py             # 对话引擎（集成 TTS）
│   ├── model_trainer.py           # 模型训练
│   ├── video_generator.py         # 视频生成
│   └── tts_service.py             # GPT-SoVITS TTS 服务封装
├── templates/                      # 前端页面
│   ├── index.html
│   ├── model_training.html
│   ├── video_generation.html
│   └── chat_system.html
├── static/                         # 静态资源
│   ├── videos/                     # 生成的视频
│   ├── audios/                     # 音频文件
│   └── text/                       # 文本文件
├── uploads/                        # 用户上传的文件
├── GPT-SoVITS-v2pro/              # 语音合成模型
└── JoyGen/                         # JoyGen 模型
```

## 核心改进

### 1. 文件上传功能
- 新增 `/upload_file` 接口
- 支持视频、音频文件上传
- 自动保存到 `uploads/` 目录
- 文件大小限制：500MB

### 2. GPT-SoVITS 集成
- 创建 `backend/tts_service.py` TTS 服务封装
- 在 `chat_engine.py` 中集成语音合成
- 支持服务可用性检查
- 自动处理连接错误

### 3. 前端优化
- 最小化修改，保持原有界面
- 添加文件选择按钮
- 添加上传功能
- 自动填充文件路径

## API 接口

### 文件上传
```
POST /upload_file
Content-Type: multipart/form-data

参数:
- file: 上传的文件

返回:
{
    "status": "success",
    "message": "文件上传成功",
    "filepath": "uploads/filename.ext"
}
```

### GPT-SoVITS TTS 调用
```python
from backend.tts_service import TTSService

tts = TTSService()
success = tts.text_to_speech(
    text="要合成的文字",
    output_path="./output.wav",
    ref_audio_path="参考音频.wav"  # 可选
)
```

## 常见问题

### 1. 语音合成失败
**错误**: `无法连接到 GPT-SoVITS 服务`

**解决**:
```bash
# 确保 GPT-SoVITS 服务已启动
cd GPT-SoVITS-v2pro
python api_v2.py -a 127.0.0.1 -p 9880
```

### 2. 文件上传失败
**错误**: `不支持的文件类型`

**解决**: 确保文件格式为：
- 视频：mp4, avi, mov
- 音频：wav, mp3, flac

### 3. 训练/推理失败
**检查**:
- Docker 服务是否运行
- 模型文件是否存在
- GPU 是否可用

## 后续优化建议

1. **视频生成集成**
   - 在 `chat_engine.py` 中完善视频生成流程
   - 调用 SyncTalk 或 JoyGen 生成最终视频

2. **语音克隆**
   - 支持用户上传参考音频
   - 实现多音色切换

3. **异步处理**
   - 训练和生成任务异步化
   - 添加任务队列和进度显示

4. **权限管理**
   - 添加用户认证
   - 文件访问控制

## 技术支持

如有问题，请检查：
1. 控制台输出日志
2. 浏览器开发者工具
3. 确保所有服务正常运行
